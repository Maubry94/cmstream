<div 
:rulled="this.rules.length !== 0"
class="relative"
>
    <div 
    class="w-full relative"
    >
        <label 
        cv-if="this.label !== false"
        :for="this.name"
        class="absolute top-[50%] -translate-y-[50%] transition-all select-none cursor-pointer"
        cv-class="{
            '!top-0 text-[0.8em]': this.isFocus || this.value,
            'opacity-[0.5]': this.disabled,
        }"
        @click="this.$refs.input.focus()"
        >
            {{ this.label }}
        </label>

        <input
        :placeholder="this.placeholder"
        @focus="focused"
        @blur="blured"
        cv-ref="input"
        cv-model="inputValue"
        class="bg-transparent py-[5px] focus:outline-none focus:border-skyblue w-full transition"
        cv-class="{
            'border-b-[2px]': this.border,
            'border-[red]': this.invalide !== false,
            'opacity-[0.5]': this.disabled,
        }"
        >

        <div class="absolute top-[50%] -translate-y-[50%] right-0 flex gap-[5px]">
            <slot/>

            <icon
            cv-show="this.value && this.clearable === true"
            name="close"
            @click="clear"
            />
        </div>

        <div 
        class="absolute left-0 w-full bg-[white] top-[calc(100%+10px)] flex flex-col gap-[5px]"
        cv-show="this.isFocus"
        >
            <div
            class="text-[black] hover:bg-skyblue hover:text-[white]"
            cv-for="item of this.filterItems"
            @click="this.selected(this.item.index)"
            >
                {{ this['return-text'](this.item.value) }}
            </div>
        </div>
    </div>

    <small class="text-[red]">{{this.invalide || ""}}</small>
</div>

<script>
    export default {
        props: {
            value: null,
            items: [],
            "return-value": value => value,
            "return-text": text => text,
            border: true,
            isFocus: false,
            label: false,
            disabled: false,
            rules: [],
            clearable: false,
            placeholder: false,
            inputValue: "",
            filter: true,
        },
        data: {
            index: -1,
            invalide: false,
            cleared: false,
            filterItems: [],
        },
        watch: {
            items(){
                if(this.filter === true){
                    let item = this.items.find(i => this['return-text'](i) === this.inputValue);
                    if(item) this.$emit("input", {target:{value: item}});
                    else this.$emit("input", {target:{value: null}});
                }
                else {
                    this.init();
                }
            },
            index(){
                if(this.index !== -1){
                    this.inputValue = this['return-text'](this.items[this.index]);
                }
            },
            inputValue(){
                this.$emit("search", this.inputValue);

                if(this.filter === true){
                    this.filterItems = this.items
                    .map((value, index) => ({value, index}))
                    .filter(v => this['return-text'](v.value).indexOf(this.inputValue) !== -1);
                    
                    if(
                        this.filterItems[0] === undefined || 
                        this['return-text'](this.filterItems[0].value) !== this.inputValue
                    ){
                        if(this.index !== -1)this.index = -1;
                        this.$emit("input", {target:{value: null}});
                    }
                    else if(this.index !== this.filterItems[0].index){
                        this.selected(this.filterItems[0].index);
                    }
                }
            }
        },
        methods: {
            selected(index){
                this.index = index;
                this.$emit("input", {target:{value: this['return-value'](this.items[this.index])}});
            },
            focused(e){
                this.isFocus = true;
                this.$emit("focus", e);
            },
            blured(e){
                setTimeout(() => this.isFocus = false, 100);
                this.$emit("blur", e);
            },
            clear(e){
                this.index = -1;
                this.$emit("input", {target:{value: null}});
                this.inputValue = "";
            },
            validate(){
                if(this.disabled === true) return true;

                for(const rule of this.rules){
                    let result = rule(this.value);
                    if(result !== true){
                        this.invalide = result;
                        return false;
                    }
                }

                if(this.invalide !== false)this.invalide = false;
                return true;
            },
            init(){
                let index = this.items.findIndex(v => JSON.stringify(this['return-value'](v)) === JSON.stringify(this.value));
                this.filterItems = this.items.map((value, index) => ({value, index}));
                if(index !== -1)this.selected(index);
            }
        },
        mounted(){
            this.$getElement().$validate = () => this.validate();
            this.init();
        }
    }
</script>

<style>
    
</style>