<div class="max-w-[1164px] h-[calc(100vh-100px)] pt-[20px] mx-auto px-7 lg:px-14 content">
    <h1 class="w-full text-[32px] font-bold border-b-[2px] border-inherit mb-[30px] text-center">Configuration de
        l'application
    </h1>
    <div class="w-full flex flex-col items-center gap-[20px]">
        <cv-form @submit="editConfigApp">
            <div class="w-full px-[20px] py-[10px] flex flex-col gap-[20px]">
                <div class="flex flex-col items-center">

                    <text-input type="text" cv-model="editAppName" placeholder="Nom d'application"
                        :value="this.configApp.APP_NAME" :rules="this.appNameRule">
                </div>
                <div class="flex flex-col items-center">

                    <text-input :type="this.lookSecret" cv-model="editSecretKey" placeholder="Clé secrète"
                        :value="this.configApp.SECRET_KEY" :rules="this.secretKeyRule">
                        <icon @click="this.lookSecretKey()"
                            class=" absolute top-[50%] -translate-y-[50%] right-0 cursor-pointer" name="eye" />
                    </text-input>
                </div>
                <div class="flex flex-col items-center">

                    <text-input type="number" cv-model="editTokenDuration" placeholder="durée du token"
                        :value="this.configApp.TOKEN_DURATION" :rules="this.tokenDurationRule" />
                </div>
                <div class="flex flex-col items-center">

                    <text-input type="text" cv-model="editHost" placeholder="Nom de domaine"
                        :value="this.configApp.HOST" :rules="this.hostRule" />
                </div>
                <div class="flex flex-col items-center">
                    <button class="border rounded-[8px] px-[20px] py-[10px] bg-skyblue text-white ">Modifier</button>
                </div>
            </div>
        </cv-form>
        <div class="w-full flex flex-col items-center gap-[20px]">
            <h1 class="w-full text-[32px] text-center font-bold border-b-[2px] border-inherit">Upload Logo</h1>
            <div class="w-full flex flex-col justify-between mb-[10px] gap-[10px]">
                <cv-form @submit="uploadLogo">
                    <label
                        class="flex justify-center w-full h-32 px-4 transition bg-white border-2 text-grey 
                        border-gray-300 border-dashed rounded-md appearance-none cursor-pointer hover:border-gray-400 focus:outline-none">
                        <span class="flex items-center">
                            <icon cv-if="this.logo === null" class="text-[40px]" name="upload"></icon>
                            <span cv-if="this.logo === null" class="font-medium text-gray-600">
                                PNG, JPEG uniquement.
                            </span>
                        </span>
                        <img cv-if="this.logo" :src="URL.createObjectURL(this.logo)"
                            class="w-[100px] h-[100px] rounded-[8px] mt-[15px]">
                        <input type="file" @change="saveFile" name="file_upload" class="hidden">
                    </label>
                    <div class="flex flex-col items-center">
                        <button
                            class="border rounded-[8px] px-[20px] py-[10px] bg-skyblue text-white mt-[30px]">Modifier</button>
                    </div>
                </cv-form>
            </div>
        </div>
    </div>
</div>
<script>
    const [impLoader, impTaob] = await Promise.all([
        import("/public/cuteVue/loader.js"),
        import("/public/cuteVue/taob.js")
    ]);

    const loaderStore = impLoader.loaderStore;
    const taob = impTaob.default;

    export default {
        data: {
            configApp: [],
            editAppName: "",
            editSecretKey: "",
            editTokenDuration: 1000,
            editHost: "",
            lookSecret: "password",
            logo: null,
        },
        static: {
            secretKeyRule: [
                (v) => !!v || "La clé secrète est requise",
                (v) => v.length >= 8 || "La clé secrète doit contenir au moins 8 caractères",
            ],
            tokenDurationRule: [
                (v) => !!v || "La durée du token est requise",
                (v) => v >= 1000 || "La durée du token doit être supérieur à 1000",
            ],
            appNameRule: [
                (v) => !!v || "Le nom de l'application est requis",
                (v) => v.length >= 3 || "Le nom de l'application doit contenir au moins 3 caractères",
            ],
            hostRule: [
                (v) => !!v || "Le nom de domaine est requis",
                (v) => v.length >= 3 || "Le nom de domaine doit contenir au moins 3 caractères",
                (v) => v.startsWith("http://") || v.startsWith("https://") || "Le nom de domaine doit commencer par http:// ou https://",
                //(v) => v.match(/^(https:\/\/|http:\/\/)[a-z0-9.:]+$/) ? "Ce champ n'est pas valide." : true
            ],
        },
        methods: {
            async getConfigApp() {
                let close = loaderStore.push();
                const response = await taob.get("/config/app").s((res) => {
                    this.configApp = res;
                    this.editTokenDuration = res.TOKEN_DURATION;
                }).e((error) => {
                    this.pushToast("error", "Erreur lors de la récupération de la configuration.");
                }).result;
                close();
            },
            async uploadLogo() {
                let close = loaderStore.push();
                const formData = new FormData();
                formData.append("logo", this.logo);
                fetch("/api/config/logo", {
                    method: "POST",
                    body: formData,
                }).then((res) => {
                    res.ok ? this.pushToast("successfull", "Le logo à bien été mis à jour.") : this.pushToast("error", "Erreur le logo n'a pas été mis à jour.");
                    this.pushToast("successfull", "Le logo à bien été mis à jour.");
                }).catch((err) => {
                    this.pushToast("error", "Erreur le logo n'a pas été mis à jour.");
                }).finally(() => {
                    close();
                });
            },
            async editConfigApp() {
                let close = loaderStore.push();
                const response = await taob.put("/config/app", {
                    APP_NAME: this.editAppName !== "" ? this.editAppName : this.configApp.APP_NAME,
                    SECRET_KEY: this.editSecretKey !== "" ? this.editSecretKey : this.configApp.SECRET_KEY,
                    TOKEN_DURATION: Number(this.editTokenDuration) > 1000 ? Number(this.editTokenDuration) : this.configApp.TOKEN_DURATION,
                    HOST: this.editHost !== "" ? this.editHost : this.configApp.HOST,

                }).s((res) => {
                    this.pushToast("successfull", "Configuration de l'application mise à jour avec succès.");
                    this.getConfigApp();
                }).e((error) => {
                    this.pushToast("error", "Erreur lors de la mise à jour de la configuration de l'application.");
                });
                close();
            },
            lookSecretKey() {
                if (this.lookSecret == "password") {
                    this.lookSecret = "text";
                } else {
                    this.lookSecret = "password";
                }
            },
            saveFile(e) {
                this.logo = e.target.files[0];
            }
        },
        stores: [
            {
                name: "toast",
                actions: ["pushToast"]
            }
        ],
        mounted() {
            this.getConfigApp();
        }

    }
</script>

<style>
</style>